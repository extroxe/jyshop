angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$timeout","$locale",function(n,e,r){var a=1,t=1,o=n.eventSources,l=n.calendarWatchEvent?n.calendarWatchEvent:angular.noop,u=function(n){var r;return n&&(r=function(){var r=arguments,a=this;e(function(){n.apply(a,r)})}),r};this.eventsFingerprint=function(n){return n._id||(n._id=t++),""+n._id+(n.id||"")+(n.title||"")+(n.url||"")+(+n.start||"")+(+n.end||"")+(n.allDay||"")+(n.className||"")+l(n)||""},this.sourcesFingerprint=function(n){return n.__id||(n.__id=a++)},this.allEvents=function(){for(var n=[],e=0,r=o.length;r>e;e++){var a=o[e];if(angular.isArray(a))n.push(a);else if(angular.isObject(a)&&angular.isArray(a.events)){var t={};for(var l in a)"_uiCalId"!==l&&"events"!==l&&(t[l]=a[l]);for(var u=0;u<a.events.length;u++)angular.extend(a.events[u],t);n.push(a.events)}}return Array.prototype.concat.apply([],n)},this.changeWatcher=function(n,e){var r,a=function(){for(var r,a,t=angular.isFunction(n)?n():n,l=[],u=0,i=t.length;i>u;u++)a=t[u],r=e(a),o[r]=a,l.push(r);return l},t=function(n,e){var r,a,t=[],o={};for(r=0,a=e.length;a>r;r++)o[e[r]]=!0;for(r=0,a=n.length;a>r;r++)o[n[r]]||t.push(n[r]);return t},o={},l=function(n,a){var l,u,i,c,d={},f=t(a,n);for(l=0,u=f.length;u>l;l++){var s=f[l];i=o[s],delete o[s];var v=e(i);v===s?r.onRemoved(i):(d[v]=s,r.onChanged(i))}var g=t(n,a);for(l=0,u=g.length;u>l;l++)c=g[l],i=o[c],d[c]||r.onAdded(i)};return r={subscribe:function(n,e){n.$watch(a,function(n,r){e&&e(n,r)===!1||l(n,r)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}},this.getFullCalendarConfig=function(n,e){var r={};return angular.extend(r,e),angular.extend(r,n),angular.forEach(r,function(n,e){"function"==typeof n&&(r[e]=u(r[e]))}),r},this.getLocaleConfig=function(n){if(!n.lang||n.useNgLocale){var e=function(n){var e,r;e=[];for(r in n)e[r]=n[r];return e},a=r.DATETIME_FORMATS;return{monthNames:e(a.MONTH),monthNamesShort:e(a.SHORTMONTH),dayNames:e(a.DAY),dayNamesShort:e(a.SHORTDAY)}}return{}}}]).directive("uiCalendar",["uiCalendarConfig",function(n){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(e,r,a,t){function o(){var r,o=a.uiCalendar?e.$parent.$eval(a.uiCalendar):{};r=t.getFullCalendarConfig(o,n);var l=t.getLocaleConfig(r);angular.extend(l,r),f={eventSources:u},angular.extend(f,l),f.calendars=null;var i={};for(var c in f)"eventSources"!==c&&(i[c]=f[c]);return JSON.stringify(i)}var l,u=e.eventSources,i=!1,c=t.changeWatcher(u,t.sourcesFingerprint),d=t.changeWatcher(t.allEvents,t.eventsFingerprint),f=null;e.destroy=function(){l&&l.fullCalendar&&l.fullCalendar("destroy"),l=a.calendar?n.calendars[a.calendar]=$(r).html(""):$(r).html("")},e.init=function(){l.fullCalendar(f)},c.onAdded=function(n){l.fullCalendar("addEventSource",n),i=!0},c.onRemoved=function(n){l.fullCalendar("removeEventSource",n),i=!0},d.onAdded=function(n){l.fullCalendar("renderEvent",n)},d.onRemoved=function(n){l.fullCalendar("removeEvents",function(e){return e._id===n._id})},d.onChanged=function(n){n._start=$.fullCalendar.moment(n.start),n._end=$.fullCalendar.moment(n.end),l.fullCalendar("updateEvent",n)},c.subscribe(e),d.subscribe(e,function(){return i===!0?(i=!1,!1):void 0}),e.$watch(o,function(){e.destroy(),e.init()})}}}]);