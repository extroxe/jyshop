app.controller("reportCtrl",["$scope","_jiyin","dataToURL","$state","$stateParams",function(t,e,i,n,o){t.reportList={},t.inputPage=1,t.list={},t.open=!1,t.back=function(){window.history.go(-1)},t.download=function(t){t.id?window.open(SITE_URL+"attachment/report_download/"+t.id):e.msg("e","请选择要下载的报告")},t.$on("attachment_id",function(e,i){t.list.attachment_id=i}),t.add=function(){t.list={},t.flag=!0,t.open=!0,$("#reportModal").modal("show"),t.$broadcast("open",{open:t.open})},t.edit=function(e){t.list=e,t.flag=!1,t.open=!0,$("#reportModal").modal("show"),t.$broadcast("open",{open:t.open})},t.delete=function(n){confirm("确定删除此报告吗?")&&e.dataPost("admin/report_admin/delete",i({id:n.id})).then(function(i){1==i.success?(e.msg("s","删除成功"),t.getData()):e.msg("e","删除失败")})},t.ok=function(){var n;if(!t.list.number)return void e.msg("e","报告编号不能为空");if(!t.list.name)return void e.msg("e","名字不能为空");if(!t.list.gender)return void e.msg("e","性别不能为空");if(!t.list.age)return void e.msg("e","年龄不能为空");if(!t.list.phone)return void e.msg("e","电话不能为空");if(!t.list.identity_card)return void e.msg("e","身份证号不能为空");if(!t.list.attachment_id)return void e.msg("e","还没有上传报告");var a=/^1(3|4|5|7|8)\d{9}$/,d=/^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X|x)$/;return t.list.phone&&0==a.test(t.list.phone)?void e.msg("e","手机号不符合规则"):t.list.identity_card&&0==d.test(t.list.identity_card)?void e.msg("e","身份证号不符合规则"):(n=1==t.flag?"admin/report_admin/add":"admin/report_admin/update",t.list.order_commodity_id=o.id,void e.dataPost(n,i(t.list)).then(function(i){1==i.success?(e.msg("s",i.msg),t.getData(),$("#reportModal").modal("hide"),t.open=!1):e.msg("e",i.msg)}))},t.getData=function(){e.dataPost("admin/report_admin/get_report_list_by_order_commodity_id",i({order_commodity_id:o.id})).then(function(e){t.reportList=e.data,t.totalPage=e.total_page})},t.getData(),t.nextPage=function(){t.inputPage<t.totalPage?(t.inputPage++,t.getData()):e.msg("e","当前是最后一页")},t.previousPage=function(){t.inputPage>1?(t.inputPage--,t.getData()):e.msg("e","当前是第一页")},t.firstPage=function(){t.inputPage=1,t.getData()},t.lastPage=function(){t.inputPage=t.totalPage,t.getData()},t.selectPage=function(e){t.inputPage=e,t.getData()}}]),app.controller("reportFileUploadCtrl",["$scope","FileUploader","_jiyin","dataToURL",function(t,e,i,n){var o=t.uploader=new e({url:SITE_URL+"attachment/upload_report"});t.$on("open",function(t,e){1==e.open&&o.clearQueue()}),o.filters.push({name:"customFilter",fn:function(){return this.queue.length<2}}),t.upload=function(e){return o.queue.length>1?void i.msg("e","只能上传一个文件"):void i.fileMd5(e._file).then(function(a){i.dataPost("attachment/check_md5",n({md5_code:a.md5Code})).then(function(i){1==i.exist?(t.$emit("attachment_id",i.attachment_id),e.file.size=e._file.size,e.progress=100,e.isSuccess=!0,e.isUploaded=!0,e.uploader.progress+=100/o.queue.length):e.upload()})})},t.uploadAll=function(){return o.queue.length>1?void i.msg("e","只能上传一个文件"):void angular.forEach(o.queue,function(e){i.fileMd5(e._file).then(function(a){i.dataPost("attachment/check_md5",n({md5_code:a.md5Code})).then(function(i){1==i.exist?(t.$emit("attachment_id",i.attachment_id),e.file.size=e._file.size,e.progress=100,e.isSuccess=!0,e.isUploaded=!0,o.progress+=100/o.queue.length):e.upload()})})})},o.onSuccessItem=function(e,i){t.$emit("attachment_id",i.attachment_id)},t.$on("clearQueue",function(){o.clearQueue()})}]);